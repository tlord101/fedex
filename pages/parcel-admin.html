<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parcel Admin - Create Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase v9 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
        }
        .location-marker {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üì¶ Parcel Admin Panel</h1>
            <p class="text-gray-600">Create and manage parcel tracking with real-time updates</p>
        </div>

        <!-- Create Parcel Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Create New Parcel</h2>
            
            <form id="parcelForm" class="space-y-6">
                <!-- Origin Section -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">üìç Origin Location</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location Name</label>
                            <input type="text" id="originName" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="e.g., New York Warehouse">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Select</label>
                            <select id="originPreset" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select preset location...</option>
                                <option value="40.7128,-74.0060">New York City</option>
                                <option value="34.0522,-118.2437">Los Angeles</option>
                                <option value="41.8781,-87.6298">Chicago</option>
                                <option value="29.7604,-95.3698">Houston</option>
                                <option value="33.4484,-112.0740">Phoenix</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Latitude</label>
                            <input type="number" id="originLat" step="any" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="40.7128">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Longitude</label>
                            <input type="number" id="originLng" step="any" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="-74.0060">
                        </div>
                    </div>
                </div>

                <!-- Destination Section -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">üéØ Destination Location</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location Name</label>
                            <input type="text" id="destName" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Los Angeles Office">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Select</label>
                            <select id="destPreset" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select preset location...</option>
                                <option value="40.7128,-74.0060">New York City</option>
                                <option value="34.0522,-118.2437">Los Angeles</option>
                                <option value="41.8781,-87.6298">Chicago</option>
                                <option value="29.7604,-95.3698">Houston</option>
                                <option value="33.4484,-112.0740">Phoenix</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Latitude</label>
                            <input type="number" id="destLat" step="any" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="34.0522">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Longitude</label>
                            <input type="number" id="destLng" step="any" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="-118.2437">
                        </div>
                    </div>
                </div>

                <!-- Delivery Duration -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">‚è±Ô∏è Delivery Duration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Duration</label>
                            <select id="durationPreset" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Custom...</option>
                                <option value="5">5 minutes (demo)</option>
                                <option value="10">10 minutes (demo)</option>
                                <option value="60">1 hour</option>
                                <option value="180">3 hours</option>
                                <option value="360">6 hours</option>
                                <option value="720">12 hours</option>
                                <option value="1440">1 day</option>
                                <option value="2880">2 days</option>
                                <option value="4320">3 days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Duration (minutes)</label>
                            <input type="number" id="durationMinutes" required min="1"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="60">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Or Duration (hours)</label>
                            <input type="number" id="durationHours" step="0.5" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="1">
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">üí° Enter either minutes OR hours. The system will calculate the appropriate duration.</p>
                </div>

                <!-- Map Preview -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">üó∫Ô∏è Route Preview</h3>
                    <div id="map"></div>
                    <p class="text-sm text-gray-500 mt-2">Click on the map to set origin (first click) and destination (second click)</p>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-4">
                    <button type="submit" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md">
                        ‚úÖ Create Parcel
                    </button>
                    <button type="button" id="resetBtn"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        üîÑ Reset
                    </button>
                </div>
            </form>

            <!-- Success Message -->
            <div id="successMessage" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <p class="font-semibold">‚úÖ Parcel created successfully!</p>
                <p class="text-sm">Tracking ID: <span id="newParcelId" class="font-mono font-bold"></span></p>
                <a id="trackingLink" href="#" target="_blank" class="text-blue-600 hover:underline text-sm">View Tracking Page ‚Üí</a>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <p class="font-semibold">‚ùå Error creating parcel</p>
                <p id="errorText" class="text-sm"></p>
            </div>
        </div>

        <!-- Recent Parcels -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìã Recent Parcels</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tracking ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Origin ‚Üí Destination</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="parcelsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading parcels...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="../config/firebase.js"></script>
    <script src="../services/parcelService.js"></script>
    <script>
        let map, originMarker, destMarker, routeLine;
        let clickCount = 0;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4); // Center of USA
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Click to set locations
            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(4);
                const lng = e.latlng.lng.toFixed(4);
                
                if (clickCount === 0) {
                    document.getElementById('originLat').value = lat;
                    document.getElementById('originLng').value = lng;
                    updateMapMarkers();
                    clickCount = 1;
                } else {
                    document.getElementById('destLat').value = lat;
                    document.getElementById('destLng').value = lng;
                    updateMapMarkers();
                    clickCount = 0;
                }
            });
        }

        // Update map markers
        function updateMapMarkers() {
            const originLat = parseFloat(document.getElementById('originLat').value);
            const originLng = parseFloat(document.getElementById('originLng').value);
            const destLat = parseFloat(document.getElementById('destLat').value);
            const destLng = parseFloat(document.getElementById('destLng').value);

            // Remove old markers
            if (originMarker) map.removeLayer(originMarker);
            if (destMarker) map.removeLayer(destMarker);
            if (routeLine) map.removeLayer(routeLine);

            // Add origin marker
            if (!isNaN(originLat) && !isNaN(originLng)) {
                originMarker = L.marker([originLat, originLng], {
                    icon: L.divIcon({
                        html: 'üìç',
                        className: 'location-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
            }

            // Add destination marker
            if (!isNaN(destLat) && !isNaN(destLng)) {
                destMarker = L.marker([destLat, destLng], {
                    icon: L.divIcon({
                        html: 'üéØ',
                        className: 'location-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
            }

            // Draw route line
            if (!isNaN(originLat) && !isNaN(originLng) && !isNaN(destLat) && !isNaN(destLng)) {
                routeLine = L.polyline([
                    [originLat, originLng],
                    [destLat, destLng]
                ], {
                    color: '#3b82f6',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);

                // Fit map to show both points
                map.fitBounds([
                    [originLat, originLng],
                    [destLat, destLng]
                ], { padding: [50, 50] });
            }
        }

        // Preset handlers
        document.getElementById('originPreset').addEventListener('change', function(e) {
            if (e.target.value) {
                const [lat, lng] = e.target.value.split(',');
                document.getElementById('originLat').value = lat;
                document.getElementById('originLng').value = lng;
                updateMapMarkers();
            }
        });

        document.getElementById('destPreset').addEventListener('change', function(e) {
            if (e.target.value) {
                const [lat, lng] = e.target.value.split(',');
                document.getElementById('destLat').value = lat;
                document.getElementById('destLng').value = lng;
                updateMapMarkers();
            }
        });

        document.getElementById('durationPreset').addEventListener('change', function(e) {
            if (e.target.value) {
                document.getElementById('durationMinutes').value = e.target.value;
                document.getElementById('durationHours').value = '';
            }
        });

        // Duration sync
        document.getElementById('durationHours').addEventListener('input', function(e) {
            if (e.target.value) {
                document.getElementById('durationMinutes').value = parseFloat(e.target.value) * 60;
            }
        });

        document.getElementById('durationMinutes').addEventListener('input', function(e) {
            if (e.target.value) {
                document.getElementById('durationHours').value = (parseFloat(e.target.value) / 60).toFixed(2);
            }
        });

        // Input changes update map
        ['originLat', 'originLng', 'destLat', 'destLng'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateMapMarkers);
        });

        // Form submission
        document.getElementById('parcelForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');
            successMsg.classList.add('hidden');
            errorMsg.classList.add('hidden');

            try {
                const parcelData = {
                    origin: {
                        name: document.getElementById('originName').value,
                        coords: [
                            parseFloat(document.getElementById('originLat').value),
                            parseFloat(document.getElementById('originLng').value)
                        ]
                    },
                    destination: {
                        name: document.getElementById('destName').value,
                        coords: [
                            parseFloat(document.getElementById('destLat').value),
                            parseFloat(document.getElementById('destLng').value)
                        ]
                    },
                    durationMinutes: parseInt(document.getElementById('durationMinutes').value)
                };

                const parcelId = await window.parcelService.createParcel(parcelData);
                
                document.getElementById('newParcelId').textContent = parcelId;
                document.getElementById('trackingLink').href = `parcel-tracking.html?id=${parcelId}`;
                successMsg.classList.remove('hidden');
                
                // Refresh parcels list
                loadRecentParcels();
                
                // Reset form after 3 seconds
                setTimeout(() => {
                    document.getElementById('parcelForm').reset();
                    clickCount = 0;
                    if (originMarker) map.removeLayer(originMarker);
                    if (destMarker) map.removeLayer(destMarker);
                    if (routeLine) map.removeLayer(routeLine);
                }, 3000);
                
            } catch (error) {
                console.error('Error creating parcel:', error);
                document.getElementById('errorText').textContent = error.message;
                errorMsg.classList.remove('hidden');
            }
        });

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('parcelForm').reset();
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            clickCount = 0;
            if (originMarker) map.removeLayer(originMarker);
            if (destMarker) map.removeLayer(destMarker);
            if (routeLine) map.removeLayer(routeLine);
        });

        // Load recent parcels
        async function loadRecentParcels() {
            const tbody = document.getElementById('parcelsTableBody');
            try {
                const parcels = await window.parcelService.getRecentParcels(10);
                
                if (parcels.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No parcels yet</td></tr>';
                    return;
                }

                tbody.innerHTML = parcels.map(parcel => {
                    const statusColors = {
                        'Picked Up': 'bg-blue-100 text-blue-800',
                        'In Transit': 'bg-yellow-100 text-yellow-800',
                        'Out for Delivery': 'bg-purple-100 text-purple-800',
                        'Delivered': 'bg-green-100 text-green-800'
                    };
                    
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">${parcel.id}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">
                                ${parcel.origin.name} ‚Üí ${parcel.destination.name}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${parcel.progressPercent}%"></div>
                                    </div>
                                    <span class="text-sm font-medium">${parcel.progressPercent}%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[parcel.currentStatus] || 'bg-gray-100 text-gray-800'}">
                                    ${parcel.currentStatus}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <a href="parcel-tracking.html?id=${parcel.id}" 
                                   class="text-blue-600 hover:text-blue-900 mr-3">Track</a>
                                <button onclick="deleteParcel('${parcel.id}')" 
                                        class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading parcels:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error loading parcels</td></tr>';
            }
        }

        // Delete parcel
        window.deleteParcel = async function(parcelId) {
            if (!confirm('Are you sure you want to delete this parcel?')) return;
            
            try {
                await window.parcelService.deleteParcel(parcelId);
                loadRecentParcels();
            } catch (error) {
                console.error('Error deleting parcel:', error);
                alert('Error deleting parcel: ' + error.message);
            }
        };

        // Initialize on load
        window.addEventListener('load', () => {
            initMap();
            loadRecentParcels();
            
            // Refresh parcels every 10 seconds
            setInterval(loadRecentParcels, 10000);
        });
    </script>
</body>
</html>
