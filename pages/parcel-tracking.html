<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Parcel - Live Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase v9 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .status-picked-up { background-color: #dbeafe; color: #1e40af; }
        .status-in-transit { background-color: #fef3c7; color: #92400e; }
        .status-out-for-delivery { background-color: #e9d5ff; color: #6b21a8; }
        .status-delivered { background-color: #d1fae5; color: #065f46; }
        
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 1s ease-in-out;
        }
        
        .timeline-step {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 2rem;
        }
        
        .timeline-step:last-child {
            padding-bottom: 0;
        }
        
        .timeline-step::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
        }
        
        .timeline-step:last-child::before {
            display: none;
        }
        
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px #e5e7eb;
        }
        
        .timeline-dot.active {
            background-color: #3b82f6;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        
        .timeline-dot.completed {
            background-color: #10b981;
            box-shadow: 0 0 0 2px #10b981;
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading State -->
    <div id="loadingState" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">Loading parcel tracking...</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden min-h-screen flex items-center justify-center">
        <div class="text-center max-w-md mx-auto px-4">
            <div class="text-6xl mb-4">‚ùå</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Parcel Not Found</h1>
            <p class="text-gray-600 mb-6" id="errorMessage">The tracking ID you entered could not be found.</p>
            <a href="parcel-admin.html" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg">
                Go to Admin Panel
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">üì¶ Parcel Tracking</h1>
                        <p class="text-gray-600">Tracking ID: <span class="font-mono font-semibold" id="trackingId">-</span></p>
                    </div>
                    <div class="text-right">
                        <div id="statusBadge" class="status-badge status-picked-up mb-2">Picked Up</div>
                        <p class="text-sm text-gray-500">Last updated: <span id="lastUpdated">-</span></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Map and Progress -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Live Map -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">üó∫Ô∏è Live Location</h2>
                        <div id="map"></div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-semibold text-gray-800">üìä Delivery Progress</h2>
                            <span class="text-2xl font-bold text-blue-600" id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar mb-4">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-600">Started</p>
                                <p class="font-semibold" id="startTime">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-600">Estimated Delivery</p>
                                <p class="font-semibold" id="endTime">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Details and Timeline -->
                <div class="space-y-6">
                    <!-- Shipment Info -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">üìç Shipment Details</h2>
                        
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-1">From</p>
                            <p class="font-semibold text-gray-800" id="originName">-</p>
                            <p class="text-xs text-gray-500" id="originCoords">-</p>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-1">To</p>
                            <p class="font-semibold text-gray-800" id="destName">-</p>
                            <p class="text-xs text-gray-500" id="destCoords">-</p>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">ETA</span>
                                <span class="text-lg font-bold text-blue-600 pulse" id="eta">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Status Timeline -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Status Timeline</h2>
                        
                        <div id="timeline">
                            <div class="timeline-step">
                                <div class="timeline-dot" id="dot-pickup"></div>
                                <div>
                                    <p class="font-semibold text-gray-800">Picked Up</p>
                                    <p class="text-sm text-gray-500">Package collected</p>
                                </div>
                            </div>
                            
                            <div class="timeline-step">
                                <div class="timeline-dot" id="dot-transit"></div>
                                <div>
                                    <p class="font-semibold text-gray-800">In Transit</p>
                                    <p class="text-sm text-gray-500">On the way</p>
                                </div>
                            </div>
                            
                            <div class="timeline-step">
                                <div class="timeline-dot" id="dot-delivery"></div>
                                <div>
                                    <p class="font-semibold text-gray-800">Out for Delivery</p>
                                    <p class="text-sm text-gray-500">Almost there</p>
                                </div>
                            </div>
                            
                            <div class="timeline-step">
                                <div class="timeline-dot" id="dot-delivered"></div>
                                <div>
                                    <p class="font-semibold text-gray-800">Delivered</p>
                                    <p class="text-sm text-gray-500">Package delivered</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Link -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-800 mb-2">üîß Administrator?</p>
                        <a href="parcel-admin.html" class="text-blue-600 hover:text-blue-800 font-semibold text-sm">
                            Go to Admin Panel ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../config/firebase.js"></script>
    <script src="../services/parcelService.js"></script>
    <script>
        let map, currentMarker, routeLine, originMarker, destMarker;
        let parcelData = null;
        let lastProgressPercent = 0;
        let unsubscribe = null;

        // Get parcel ID from URL
        function getParcelIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Initialize map
        function initMap(origin, destination) {
            if (!map) {
                map = L.map('map').setView([39.8283, -98.5795], 4);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            }

            // Clear existing layers
            if (routeLine) map.removeLayer(routeLine);
            if (originMarker) map.removeLayer(originMarker);
            if (destMarker) map.removeLayer(destMarker);
            if (currentMarker) map.removeLayer(currentMarker);

            // Add origin marker
            originMarker = L.marker(origin, {
                icon: L.divIcon({
                    html: 'üìç',
                    className: 'location-marker',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('Origin');

            // Add destination marker
            destMarker = L.marker(destination, {
                icon: L.divIcon({
                    html: 'üéØ',
                    className: 'location-marker',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('Destination');

            // Draw route line
            routeLine = L.polyline([origin, destination], {
                color: '#94a3b8',
                weight: 3,
                opacity: 0.5,
                dashArray: '10, 10'
            }).addTo(map);

            // Add current position marker (initially at origin)
            currentMarker = L.marker(origin, {
                icon: L.divIcon({
                    html: 'üöö',
                    className: 'location-marker pulse',
                    iconSize: [40, 40]
                })
            }).addTo(map).bindPopup('Current Location');

            // Fit map to show entire route
            map.fitBounds([origin, destination], { padding: [50, 50] });
        }

        // Animate marker to new position
        function animateMarker(newPosition, duration = 1000) {
            if (!currentMarker) return;

            const startPosition = currentMarker.getLatLng();
            const startTime = Date.now();

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Ease-in-out interpolation
                const eased = progress < 0.5 
                    ? 2 * progress * progress 
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;

                const lat = startPosition.lat + (newPosition[0] - startPosition.lat) * eased;
                const lng = startPosition.lng + (newPosition[1] - startPosition.lng) * eased;

                currentMarker.setLatLng([lat, lng]);

                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }

            animate();
        }

        // Update UI with parcel data
        function updateUI(parcel) {
            parcelData = parcel;

            // Update tracking ID
            document.getElementById('trackingId').textContent = parcel.id;

            // Update status
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = parcel.currentStatus;
            statusBadge.className = 'status-badge status-' + parcel.currentStatus.toLowerCase().replace(/ /g, '-');

            // Update last updated time
            document.getElementById('lastUpdated').textContent = window.parcelService.formatTimestamp(parcel.lastUpdated);

            // Update progress bar
            document.getElementById('progressPercent').textContent = Math.round(parcel.progressPercent) + '%';
            document.getElementById('progressBar').style.width = parcel.progressPercent + '%';

            // Update times
            document.getElementById('startTime').textContent = window.parcelService.formatTimestamp(parcel.startTime);
            document.getElementById('endTime').textContent = window.parcelService.formatTimestamp(parcel.endTime);

            // Update ETA
            document.getElementById('eta').textContent = window.parcelService.calculateETA(parcel.startTime, parcel.endTime);

            // Update shipment details
            document.getElementById('originName').textContent = parcel.origin.name;
            document.getElementById('originCoords').textContent = `${parcel.origin.coords[0].toFixed(4)}, ${parcel.origin.coords[1].toFixed(4)}`;
            document.getElementById('destName').textContent = parcel.destination.name;
            document.getElementById('destCoords').textContent = `${parcel.destination.coords[0].toFixed(4)}, ${parcel.destination.coords[1].toFixed(4)}`;

            // Update timeline
            updateTimeline(parcel.progressPercent);

            // Initialize or update map
            if (!map) {
                initMap(parcel.origin.coords, parcel.destination.coords);
            }

            // Animate marker to new position
            const currentPosition = window.parcelService.interpolatePosition(
                parcel.origin.coords,
                parcel.destination.coords,
                parcel.progressPercent
            );

            if (Math.abs(parcel.progressPercent - lastProgressPercent) > 0.1) {
                animateMarker(currentPosition, 1000);
                lastProgressPercent = parcel.progressPercent;
            }
        }

        // Update timeline visual state
        function updateTimeline(progressPercent) {
            const dots = {
                'dot-pickup': 0,
                'dot-transit': 25,
                'dot-delivery': 75,
                'dot-delivered': 100
            };

            Object.entries(dots).forEach(([dotId, threshold]) => {
                const dot = document.getElementById(dotId);
                if (progressPercent >= threshold) {
                    dot.className = 'timeline-dot completed';
                } else if (progressPercent >= threshold - 5) {
                    dot.className = 'timeline-dot active pulse';
                } else {
                    dot.className = 'timeline-dot';
                }
            });
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        // Show main content
        function showMainContent() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Load parcel data
        async function loadParcel() {
            const parcelId = getParcelIdFromUrl();
            
            if (!parcelId) {
                showError('No tracking ID provided. Please check your URL.');
                return;
            }

            try {
                // Set up real-time listener
                unsubscribe = window.parcelService.listenToParcel(parcelId, (parcel, error) => {
                    if (error) {
                        console.error('Error listening to parcel:', error);
                        showError('Error loading parcel data: ' + error.message);
                        return;
                    }

                    if (!parcel) {
                        showError('Parcel not found. Please check the tracking ID.');
                        return;
                    }

                    updateUI(parcel);
                    showMainContent();
                });

            } catch (error) {
                console.error('Error loading parcel:', error);
                showError('Error loading parcel: ' + error.message);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // Initialize on load
        window.addEventListener('load', () => {
            // Wait for Firebase to initialize
            setTimeout(() => {
                loadParcel();
            }, 500);
        });
    </script>
</body>
</html>
