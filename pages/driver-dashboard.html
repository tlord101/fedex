<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - FedEx Clone</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js"></script>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">üì¶ FedEx Clone</div>
            <ul class="nav-links">
                <li><a href="driver-dashboard.html">Dashboard</a></li>
                <li><a href="driver-deliveries.html">Deliveries</a></li>
                <li><a href="driver-earnings.html">Earnings</a></li>
            </ul>
            <div class="nav-buttons">
                <button id="logout-btn" class="btn btn-outline btn-small">Logout</button>
            </div>
        </nav>
    </header>

    <main style="padding: 2rem 0; min-height: calc(100vh - 200px); background-color: var(--light-bg);">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1>Welcome, <span id="driver-name">Driver</span></h1>
                    <p style="color: var(--text-light);">Manage your deliveries and earnings</p>
                </div>
                <button onclick="startDeliveries()" class="btn btn-primary">Start Delivering</button>
            </div>

            <!-- Statistics -->
            <div class="grid grid-4" style="margin-bottom: 2rem;">
                <div class="card">
                    <h4 style="color: var(--text-light); margin: 0;">Today's Deliveries</h4>
                    <h2 id="stat-today" style="margin: 0.5rem 0; color: var(--primary-color);">0</h2>
                </div>
                <div class="card">
                    <h4 style="color: var(--text-light); margin: 0;">Rating</h4>
                    <h2 id="stat-rating" style="margin: 0.5rem 0; color: var(--warning-color);">5.0 ‚≠ê</h2>
                </div>
                <div class="card">
                    <h4 style="color: var(--text-light); margin: 0;">Total Deliveries</h4>
                    <h2 id="stat-total" style="margin: 0.5rem 0; color: var(--success-color);">0</h2>
                </div>
                <div class="card">
                    <h4 style="color: var(--text-light); margin: 0;">This Month Earnings</h4>
                    <h2 id="stat-earnings" style="margin: 0.5rem 0; color: var(--primary-color);">$0</h2>
                </div>
            </div>

            <!-- Current Shipment -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1.5rem;">Current Delivery</h2>
                <div id="current-shipment" style="padding: 2rem; text-align: center; color: var(--text-light);">
                    <p>No active delivery. Start delivering to get a shipment assigned.</p>
                </div>
            </div>

            <!-- Recent Deliveries -->
            <div class="card">
                <h2 style="margin-bottom: 1.5rem;">Recent Deliveries</h2>
                <div id="recent-deliveries" style="display: grid; gap: 1rem;">
                    <p style="text-align: center; color: var(--text-light);">Loading deliveries...</p>
                </div>
            </div>
        </div>
    </main>

    <footer style="background-color: #1a1a1a; color: white; padding: 2rem 0; margin-top: 4rem;">
        <div class="container">
            <p style="text-align: center;">&copy; 2024 FedEx Clone. All rights reserved.</p>
        </div>
    </footer>

    <script src="../config/firebase.js"></script>
    <script src="../config/constants.js"></script>
    <script src="../services/authService.js"></script>
    <script src="../services/driverService.js"></script>
    <script src="../services/shipmentService.js"></script>
    <script src="../services/uiService.js"></script>
    <script src="../services/locationService.js"></script>

    <script>
        let currentDriverId = null;

        // Check if user is authenticated
        authService.subscribe(async (event, user) => {
            if (event === 'auth-change') {
                if (!user) {
                    window.location.href = 'driver-register.html';
                } else {
                    initDashboard();
                }
            }
        });

        async function initDashboard() {
            const user = authService.currentUser;
            document.getElementById('driver-name').textContent = user.displayName || 'Driver';

            // Find driver record
            const snapshot = await window.firebaseApp.db.collection(CONSTANTS.COLLECTIONS.DRIVERS)
                .where('email', '==', user.email)
                .limit(1)
                .get();

            if (snapshot.empty) {
                window.location.href = 'driver-register.html';
                return;
            }

            const driverData = snapshot.docs[0].data();
            currentDriverId = snapshot.docs[0].id;

            // Load statistics
            const stats = await driverService.getDriverStats(currentDriverId);
            if (stats.success) {
                document.getElementById('stat-today').textContent = '0'; // Would load from API
                document.getElementById('stat-rating').textContent = `${stats.stats.averageRating.toFixed(1)} ‚≠ê`;
                document.getElementById('stat-total').textContent = stats.stats.totalDeliveries;
                document.getElementById('stat-earnings').textContent = uiService.formatCurrency(stats.stats.totalEarnings);
            }

            // Load current shipment
            loadCurrentShipment();
            loadRecentDeliveries();
        }

        async function loadCurrentShipment() {
            const driver = await driverService.getDriver(currentDriverId);
            const currentDiv = document.getElementById('current-shipment');

            if (driver.currentShipmentId) {
                const shipment = await shipmentService.getShipment(driver.currentShipmentId);
                currentDiv.innerHTML = `
                    <div style="text-align: left; background-color: #f0f0f0; padding: 1.5rem; border-radius: 8px;">
                        <h3 style="margin-top: 0;">${shipment.trackingNumber}</h3>
                        <p><strong>Recipient:</strong> ${shipment.recipientName}</p>
                        <p><strong>Address:</strong> ${shipment.recipientAddress.street}, ${shipment.recipientAddress.city}</p>
                        <p><strong>Weight:</strong> ${shipment.weight} lbs</p>
                        <div style="margin-top: 1rem;">
                            <button onclick="completeDelivery()" class="btn btn-success">Mark as Delivered</button>
                            <button onclick="contactRecipient()" class="btn btn-outline btn-small" style="margin-left: 0.5rem;">Contact</button>
                        </div>
                    </div>
                `;
            } else {
                currentDiv.innerHTML = '<p style="text-align: center; color: var(--text-light); margin: 0;">No active delivery. Start delivering to get a shipment assigned.</p>';
            }
        }

        async function loadRecentDeliveries() {
            const snapshot = await window.firebaseApp.db.collection(CONSTANTS.COLLECTIONS.SHIPMENTS)
                .where('deliveredBy', '==', currentDriverId)
                .orderBy('deliveredAt', 'desc')
                .limit(5)
                .get();

            const deliveriesDiv = document.getElementById('recent-deliveries');
            if (snapshot.empty) {
                deliveriesDiv.innerHTML = '<p style="text-align: center; color: var(--text-light);">No deliveries yet</p>';
                return;
            }

            deliveriesDiv.innerHTML = snapshot.docs.map(doc => {
                const shipment = doc.data();
                return `
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">${shipment.trackingNumber}</h4>
                                <p style="margin: 0; color: var(--text-light);">${shipment.recipientAddress.city}</p>
                            </div>
                            <div style="text-align: right;">
                                <span class="tracking-status status-delivered">Delivered</span>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-light); font-size: 0.9rem;">
                                    ${uiService.formatDate(shipment.deliveredAt)}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startDeliveries() {
            uiService.showModal('Start Delivering', 'Finding available shipments near you...', [
                {
                    label: 'Start',
                    type: 'primary',
                    action: 'start',
                    onClick: () => {
                        uiService.showToast('Shipment assigned!', 'success');
                        loadCurrentShipment();
                    }
                }
            ]);
        }

        async function completeDelivery() {
            const driver = await driverService.getDriver(currentDriverId);
            const confirmed = confirm('Confirm delivery completion?');
            
            if (confirmed) {
                uiService.showLoading('Marking delivery as complete...');
                await driverService.completeDelivery(currentDriverId, driver.currentShipmentId, null);
                uiService.hideLoading();
                uiService.showToast('Delivery completed!', 'success');
                loadCurrentShipment();
                loadRecentDeliveries();
            }
        }

        function contactRecipient() {
            uiService.showToast('Contacting recipient...', 'info');
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await authService.signOut();
            window.location.href = '../index.html';
        });
    </script>
</body>
</html>
